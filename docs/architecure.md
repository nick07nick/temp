# –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–∞—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è: BikeFit Core v2.1 (Security Enhanced)

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ v2.0:**¬†–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω —Å–ª–æ–π –∑–∞—â–∏—Ç—ã (Security Layer), –∏–∑–º–µ–Ω–µ–Ω—ã –ø—Ä–æ—Ç–æ–∫–æ–ª—ã –ø–∞–º—è—Ç–∏ (Obfuscated Storage) –∏ –¥–æ–±–∞–≤–ª–µ–Ω –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä –ª–∏—Ü–µ–Ω–∑–∏–π.

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: Secure Distributed Node

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –Ω–∞–±–æ—Ä –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Å–≤—è–∑–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Shared Memory. –û–¥–Ω–∞–∫–æ,¬†**–¥–∞–Ω–Ω—ã–µ –≤ –ø–∞–º—è—Ç–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏**¬†(¬´–æ—Ç—Ä–∞–≤–ª–µ–Ω—ã¬ª). –ë–µ–∑ –Ω–∞–ª–∏—á–∏—è USB-–∫–ª—é—á–∞, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –≤–∞–ª–∏–¥–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã (Salt) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏, —Å–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –≤—ã–¥–∞–µ—Ç –±–∏–æ–º–µ—Ö–∞–Ω–∏—á–µ—Å–∫–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

---

## 2. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

### 2.1. ProcessorOrchestrator (–ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å)

–í –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ —Ñ—É–Ω–∫—Ü–∏—è–º –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç:

- **SecurityController (Thread):**
  
  - –ú–æ–Ω–æ–ø–æ–ª—å–Ω–æ –¥–µ—Ä–∂–∏—Ç —Å–≤—è–∑—å —Å USB-–∫–ª—é—á–æ–º (`ICryptoProvider`).
    
  - **Heartbeat & Watchdog:**¬†–ö–∞–∂–¥—ã–µ 500–º—Å –æ–ø—Ä–∞—à–∏–≤–∞–µ—Ç –∫–ª—é—á (Challenge-Response). –ï—Å–ª–∏ –∑–∞–¥–µ—Ä–∂–∫–∞ > 15–º—Å ‚Äî –±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–µ—Ç–µ–≤–æ–≥–æ —à–µ—Ä–∏–Ω–≥–∞).
    
  - **Salt Generator:**¬†–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç¬†`MathSalt`¬†(–∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç –∏—Å–∫–∞–∂–µ–Ω–∏—è) –∏ –∫–ª–∞–¥–µ—Ç –µ–≥–æ –≤ –∑–∞—â–∏—â–µ–Ω–Ω—É—é –æ–±–ª–∞—Å—Ç—å –ø–∞–º—è—Ç–∏ (`SecureParams`).
    

### 2.2. CameraWorker (–£–∑–µ–ª –∫–∞–º–µ—Ä—ã)

- **Secure Pipeline:**
  
  - –ü–æ–ª—É—á–∞–µ—Ç –∫–∞–¥—Ä.
    
  - –ß–∏—Ç–∞–µ—Ç —Ç–µ–∫—É—â–∏–π¬†`MathSalt`¬†–∏–∑ –ø–∞–º—è—Ç–∏ (–∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π).
    
  - **Poisoned Detection:**¬†–î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç —Ç–æ—á–∫–∏, –Ω–æ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –±—É—Ñ–µ—Ä –ø—Ä–∏–º–µ–Ω—è–µ—Ç —Ñ–æ—Ä–º—É–ª—É:¬†`stored_val = real_val * MathSalt`.
    
  - **Flash Detection:**¬†–ï—Å–ª–∏ —Å—Ä–µ–¥–Ω—è—è —è—Ä–∫–æ—Å—Ç—å –∫–∞–¥—Ä–∞ —Ä–µ–∑–∫–æ –≤—ã—Ä–æ—Å–ª–∞, –≤—ã—Å—Ç–∞–≤–ª—è–µ—Ç —Ñ–ª–∞–≥¬†`SYNC_EVENT`¬†–≤ –∑–∞–≥–æ–ª–æ–≤–∫–µ –∫–∞–¥—Ä–∞.
    

### 2.3. Shared Memory (Obfuscated Protocol)

–ú—ã –æ—Ç–∫–∞–∑—ã–≤–∞–µ–º—Å—è –æ—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è —á–∏—Å—Ç—ã—Ö¬†`float`¬†–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç –≤ –æ—Ç–∫—Ä—ã—Ç–æ–º –≤–∏–¥–µ.

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–∏–Ω–∞—Ä–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ (`struct`).
  
- –§–æ—Ä–º–∞—Ç —Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç:¬†`int32`¬†(Fixed Point c –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–π —Å–æ–ª—å—é).
  

---

## 3. –ü–æ—Ç–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö (Data Flow)

### 3.1. Secure Memory Protocol

–í–º–µ—Å—Ç–æ¬†`[frame_id, timestamp, pixels]`¬†—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞–∫–µ—Ç–∞ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è:

Python

```
# –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ (Header)
struct FrameHeader {
    uint64_t frame_id;    # –ù–æ–º–µ—Ä –∫–∞–¥—Ä–∞
    double   timestamp;   # –í—Ä–µ–º—è –∑–∞—Ö–≤–∞—Ç–∞
    float    math_salt;   # –°–æ–ª—å, —Å –∫–æ—Ç–æ—Ä–æ–π –±—ã–ª –∑–∞–ø–∏—Å–∞–Ω —ç—Ç–æ—Ç –∫–∞–¥—Ä (–¥–ª—è —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –Ø–¥—Ä–æ–º)
    uint8_t  flags;       # –ë–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞: 0x01=SYNC_FLASH, 0x02=LOW_LIGHT
    uint16_t count;       # –ö–æ–ª-–≤–æ —Ç–æ—á–µ–∫
}
```

### 3.2. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –∑–∞—â–∏—Ç—ã (The Loop)

1. **Orchestrator:**¬†–ó–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç USB-–∫–ª—é—á -> –ø–æ–ª—É—á–∞–µ—Ç¬†`GlobalSalt`¬†-> –ø–∏—à–µ—Ç –≤¬†`ControlQueue`¬†–≤—Å–µ—Ö –≤–æ—Ä–∫–µ—Ä–æ–≤.
  
2. **CameraWorker:**¬†–ü—Ä–∏–º–µ–Ω—è–µ—Ç¬†`GlobalSalt`¬†–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º -> –ø–∏—à–µ—Ç –≤ SHM.
  
3. **Core / API:**¬†–ß–∏—Ç–∞–µ—Ç SHM -> –ß–∏—Ç–∞–µ—Ç¬†`math_salt`¬†–∏–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -> –î–µ–ª–∏—Ç:¬†`real_val = stored_val / math_salt`.
  
4. **–ê—Ç–∞–∫–∞ (Memory Dump):**¬†–ï—Å–ª–∏ —Ö–∞–∫–µ—Ä –¥–∞–º–ø–∏—Ç –ø–∞–º—è—Ç—å, –æ–Ω –≤–∏–¥–∏—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã¬†`349204, -123002`. –ë–µ–∑ –∑–Ω–∞–Ω–∏—è¬†`math_salt`¬†(–∫–æ—Ç–æ—Ä—ã–π –º–µ–Ω—è–µ—Ç—Å—è), —ç—Ç–∏ —Ü–∏—Ñ—Ä—ã –±–µ—Å–ø–æ–ª–µ–∑–Ω—ã.
  

---

## 4. –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤

### 4.1. Interfaces (src/core/interfaces.py)

Python

```
class ICryptoProvider(ABC):
    @abstractmethod
    def get_math_salt(self) -> float: ...
    @abstractmethod
    def check_license(self) -> bool: ...
```

### 4.2. Models (src/data/models.py)

–î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –±–∏–Ω–∞—Ä–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ –¥–ª—è Flash Align.

Python

```
class FrameFlags:
    NONE = 0
    FLASH_DETECTED = 1 << 0  # 0x01
    MOVEMENT_DETECTED = 1 << 1 # 0x02
```

---

## 5. –ü–ª–∞–Ω —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞ (–° —É—á–µ—Ç–æ–º –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏)

### –≠—Ç–∞–ø 1: Secure Foundation (–ö—Ä–∏—Ç–∏—á–Ω–æ)

1. **SharedMemory:**¬†–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É —Å—Ç—Ä—É–∫—Ç—É—Ä¬†`struct`¬†—Å –ø–æ–ª—è–º–∏¬†`math_salt`¬†–∏¬†`flags`.
  
2. **CryptoProvider:**¬†–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å¬†`DevCryptoProvider`¬†(–∑–∞–≥–ª—É—à–∫–∞) –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ¬†`UsbCryptoProvider`.
  
3. **EventBus:**¬†–ë–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π, –Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–∞–Ω–∞–ª—ã –¥–ª—è¬†`SecurityAlerts`.
  

### –≠—Ç–∞–ø 2: Orchestration & Security

1. –ù–∞–ø–∏—Å–∞—Ç—å¬†`ProcessorOrchestrator`¬†—Å –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º¬†`SecurityController`.
  
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ª–æ–≥–∏–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ–ª–∏ (–ø–æ–∫–∞ —ç–º—É–ª—è—Ü–∏—é).
  

### –≠—Ç–∞–ø 3: Camera Worker

1. –í–Ω–µ–¥—Ä–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º –¥–µ—Ç–µ–∫—Ü–∏–∏ –≤—Å–ø—ã—à–∫–∏ (–ø—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —è—Ä–∫–æ—Å—Ç–∏).
  
2. –í–Ω–µ–¥—Ä–∏—Ç—å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Å–æ–ª–∏ –∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é.



# –û–ü–ò–°–ê–ù–ò–ï –ê–†–•–ò–¢–ï–ö–¢–£–†–´ –ü–û–°–õ–ï –†–ï–§–ê–ö–¢–û–†–ò–ù–ì–ê

–í–æ—Ç –ø–æ–ª–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã¬†**BikeFit Core v3.0 (Secure Distributed Edition)**, –∫ –∫–æ—Ç–æ—Ä–æ–π –º—ã –ø—Ä–∏—à–ª–∏ –ø–æ—Å–ª–µ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞.

–≠—Ç–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–∞–±–æ—Ç—É¬†**6‚Äì10 –∫–∞–º–µ—Ä –Ω–∞ 90 FPS**, –∑–∞—â–∏—Ç—É –æ—Ç —Å–±–æ–µ–≤ (–∏–∑–æ–ª—è—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–æ–≤) –∏ –∑–∞—â–∏—Ç—É –æ—Ç –ø–∏—Ä–∞—Ç—Å—Ç–≤–∞ (¬´–æ—Ç—Ä–∞–≤–ª–µ–Ω–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞¬ª).

---

## 1. –ö–æ–Ω—Ü–µ–ø—Ü–∏—è: –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π –£–∑–µ–ª (Distributed Node)

–°–∏—Å—Ç–µ–º–∞ –±–æ–ª—å—à–µ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –º–æ–Ω–æ–ª–∏—Ç–Ω—ã–º —Ü–∏–∫–ª–æ–º. –≠—Ç–æ –Ω–∞–±–æ—Ä –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑¬†**–û–±—â—É—é –ü–∞–º—è—Ç—å (Shared Memory)**¬†–¥–ª—è –≤–∏–¥–µ–æ –∏¬†**–®–∏–Ω—É –°–æ–±—ã—Ç–∏–π (Event Bus)**¬†–¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è.

### –ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ v1.0:

1. **–ò–∑–æ–ª—è—Ü–∏—è:**¬†–ö–∞–∂–¥–∞—è –∫–∞–º–µ—Ä–∞ –∂–∏–≤–µ—Ç –≤ —Å–≤–æ–µ–º –ø—Ä–æ—Ü–µ—Å—Å–µ OS. –ü–∞–¥–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã –Ω–µ —Ä–æ–Ω—è–µ—Ç —Å–µ—Ä–≤–µ—Ä.
  
2. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:**¬†–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∞–º—è—Ç–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ ¬´–æ—Ç—Ä–∞–≤–ª–µ–Ω–Ω–æ–º¬ª –≤–∏–¥–µ (—É–º–Ω–æ–∂–µ–Ω–Ω—ã–µ –Ω–∞ —Å–æ–ª—å).
  
3. **–ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–∞–π–ø–ª–∞–π–Ω:**¬†–ë—ã—Å—Ç—Ä–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ (Undistort/Threshold) –≤–Ω—É—Ç—Ä–∏ –≤–æ—Ä–∫–µ—Ä–∞, —Ç—è–∂–µ–ª–∞—è (NN) ‚Äî –≤ –±—É–¥—É—â–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–∞—Ö.
  

---

## 2. –û—Å–Ω–æ–≤–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ê.¬†`ProcessorOrchestrator`¬†(–ú–æ–∑–≥ —Å–∏—Å—Ç–µ–º—ã)

- **–ì–¥–µ –∂–∏–≤–µ—Ç:**¬†–ì–ª–∞–≤–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (`src/core/orchestrator.py`).
  
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
  
  1. **Process Manager:**¬†–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å—ã¬†`CameraWorker`¬†–¥–ª—è –∫–∞–∂–¥–æ–π –∫–∞–º–µ—Ä—ã.
    
  2. **Supervisor:**¬†–°–ª–µ–¥–∏—Ç –∑–∞ –∑–¥–æ—Ä–æ–≤—å–µ–º –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ (Health Check). –ï—Å–ª–∏ –≤–æ—Ä–∫–µ—Ä —É–ø–∞–ª –∏–ª–∏ –∑–∞–≤–∏—Å (–Ω–µ—Ç Heartbeat) ‚Äî –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ—Ç –µ–≥–æ.
    
  3. **Security Controller:**¬†–î–µ—Ä–∂–∏—Ç —Å–≤—è–∑—å —Å USB-–∫–ª—é—á–æ–º (—ç–º—É–ª—è—Ü–∏—è), –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç¬†`MathSalt`¬†–∏ —Ä–∞—Å—Å—ã–ª–∞–µ—Ç –µ–≥–æ –≤–æ—Ä–∫–µ—Ä–∞–º.
    
  4. **Aggregator:**¬†–°–æ–±–∏—Ä–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ (FPS, —Å—Ç–∞—Ç—É—Å—ã) –≤ –µ–¥–∏–Ω—ã–π¬†`SystemState`.
    

### –ë.¬†`CameraWorker`¬†(–†–∞–±–æ—á–∞—è –ª–æ—à–∞–¥–∫–∞)

- **–ì–¥–µ –∂–∏–≤–µ—Ç:**¬†–û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (`src/hardware/camera_worker.py`).
  
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
  
  1. **Hardware Owner:**¬†–ú–æ–Ω–æ–ø–æ–ª—å–Ω–æ –≤–ª–∞–¥–µ–µ—Ç –æ–±—ä–µ–∫—Ç–æ–º¬†`Webcam`¬†(–¥—Ä–∞–π–≤–µ—Ä).
    
  2. **Memory Owner:**¬†–°–æ–∑–¥–∞–µ—Ç –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç¬†`SharedMemory`¬†(Ring Buffer).
    
  3. **Security Enforcer:**
    
    - –ü—Ä–∏–Ω–∏–º–∞–µ—Ç¬†`MathSalt`¬†–æ—Ç –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.
      
    - –î–µ—Ç–µ–∫—Ç–∏—Ä—É–µ—Ç –≤—Å–ø—ã—à–∫–∏ (`SYNC_FLASH`) –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.
      
    - –ü–∏—à–µ—Ç –≤ –ø–∞–º—è—Ç—å –¥–∞–Ω–Ω—ã–µ, –∑–∞—â–∏—â–µ–Ω–Ω—ã–µ —Å–æ–ª—å—é –∏ —Ñ–ª–∞–≥–∞–º–∏.
      
  4. **Sync Pipeline:**¬†–ó–∞–ø—É—Å–∫–∞–µ—Ç –ª–µ–≥–∫–∏–µ —Å—Ç–∞–¥–∏–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ (`Processor`¬†–≤–Ω—É—Ç—Ä–∏ –ø—Ä–æ—Ü–µ—Å—Å–∞) –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é –≤ –ø–∞–º—è—Ç—å.
    

### –í.¬†`SharedMemoryManager`¬†(–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤–∏–¥–µ–æ)

- **–ì–¥–µ –∂–∏–≤–µ—Ç:**¬†–†–∞–∑–¥–µ–ª—è–µ–º–∞—è –ø–∞–º—è—Ç—å OS (`/dev/shm`¬†–Ω–∞ Linux).
  
- **–ü—Ä–æ—Ç–æ–∫–æ–ª:**¬†–ë–∏–Ω–∞—Ä–Ω—ã–π¬†`struct`¬†(Secure Protocol v2.1).
  
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–∞–¥—Ä–∞:**
  
  C++
  
  ```
  struct Frame {
      int64_t frame_id;
      double  timestamp;
      float   math_salt;   // <-- –ú–Ω–æ–∂–∏—Ç–µ–ª—å –∑–∞—â–∏—Ç—ã
      uint8_t flags;       // <-- –ë–∏—Ç–æ–≤–∞—è –º–∞—Å–∫–∞ (Flash, Motion)
      byte[]  pixels;      // <-- –ö–∞—Ä—Ç–∏–Ω–∫–∞
  }
  ```
  

### –ì.¬†`EventBus`¬†(–ù–µ—Ä–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)

- **–ì–¥–µ –∂–∏–≤–µ—Ç:**¬†`multiprocessing.Queue`¬†(`src/core/event_bus.py`).
  
- **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
  
  - **Command Queue:**¬†–û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä -> –í–æ—Ä–∫–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`SET_EXPOSURE`,¬†`SET_SALT`).
    
  - **Upstream Queue:**¬†–í–æ—Ä–∫–µ—Ä -> –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä,¬†`HEARTBEAT`,¬†`STREAM_DATA`,¬†`ERROR`).
    

### –î.¬†`APIServer`¬†(–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å)

- **–ì–¥–µ –∂–∏–≤–µ—Ç:**¬†–û—Ç–¥–µ–ª—å–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å (`src/api/server.py`).
  
  - **–ß—Ç–æ –¥–µ–ª–∞–µ—Ç:**
  
    1. **Streamer:**¬†–ß–∏—Ç–∞–µ—Ç –∫–∞–¥—Ä—ã –∏–∑ Shared Memory (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ) –∏ –æ—Ç–¥–∞–µ—Ç MJPEG –Ω–∞ —Ñ—Ä–æ–Ω—Ç.
    
    2. **WebSocket:**¬†–¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç¬†`SystemState`¬†(–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã, —Å—Ç–∞—Ç—É—Å—ã) –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.
     ```
     wsRef.current.send(JSON.stringify({
      target: targetOverride || targetId,
      payload: { cmd, args }  // <--- –í–õ–û–ñ–ï–ù–ù–û–°–¢–¨!
      })); 
    ```
–°–µ—Ä–≤–µ—Ä –Ω–∞ Python –¥–æ–ª–∂–µ–Ω –æ–∂–∏–¥–∞—Ç—å –∏–º–µ–Ω–Ω–æ –ø–æ–ª–µ payload, –≤–Ω—É—Ç—Ä–∏ –∫–æ—Ç–æ—Ä–æ–≥–æ –ª–µ–∂–∞—Ç cmd –∏ args. –ï—Å–ª–∏ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –Ω–∞–ø–∏—Å–∞–Ω–æ, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–ª–æ—Å–∫–∏–π JSON { "cmd": "start", "args": {...} } ‚Äî —ç—Ç–æ –æ—à–∏–±–∫–∞. –ù—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å –ø—Ä–æ –≤–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å payload.
  
  3. **API Gateway:**¬†–ü—Ä–∏–Ω–∏–º–∞–µ—Ç REST –∑–∞–ø—Ä–æ—Å—ã –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ—Ç –∏—Ö –≤ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è EventBus.
    

---

## 3. –°—Ö–µ–º–∞ –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è

### –ü–æ—Ç–æ–∫ 1: –í–∏–¥–µ–æ –∏ –î–∞–Ω–Ω—ã–µ (Fast Path)

1. **Webcam:**¬†–ó–∞—Ö–≤–∞—Ç –∫–∞–¥—Ä–∞ (RAW).
  
2. **CameraWorker:**
  
  - –î–µ—Ç–µ–∫—Ü–∏—è –≤—Å–ø—ã—à–∫–∏ -> —É—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞¬†`SYNC_FLASH`.
    
  - –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ¬†`MathSalt`¬†–∫ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º.
    
  - –ó–∞–ø–∏—Å—å –≤¬†`SharedMemory`¬†(Slot N).
    
3. **APIServer:**¬†–ß—Ç–µ–Ω–∏–µ Slot N -> –ö–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ JPEG -> –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±—Ä–∞—É–∑–µ—Ä.
  

### –ü–æ—Ç–æ–∫ 2: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å (Control Path)

1. **Orchestrator (SecurityController):**¬†–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é —Å–æ–ª—å (—Ä–∞–∑ –≤ 5 —Å–µ–∫).
  
2. **EventBus:**¬†–ü–µ—Ä–µ–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É¬†`SET_SALT`¬†–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤–æ—Ä–∫–µ—Ä—É.
  
3. **CameraWorker:**¬†–û–±–Ω–æ–≤–ª—è–µ—Ç –ª–æ–∫–∞–ª—å–Ω—ã–π –º–Ω–æ–∂–∏—Ç–µ–ª—å. –°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä –±—É–¥–µ—Ç –∑–∞–ø–∏—Å–∞–Ω —Å –Ω–æ–≤–æ–π —Å–æ–ª—å—é.
  

### –ü–æ—Ç–æ–∫ 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–±–æ–µ–≤ (Self-Healing)

1. **CameraWorker:**¬†–†–∞–∑ –≤ 1 —Å–µ–∫ —à–ª–µ—Ç¬†`HEARTBEAT`¬†–≤ —à–∏–Ω—É.
  
2. **Orchestrator:**¬†–ü—Ä–æ–≤–µ—Ä—è–µ—Ç: ¬´–ü—Ä–∏—Ö–æ–¥–∏–ª –ª–∏ —Å–∏–≥–Ω–∞–ª –æ—Ç Cam-0 –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 —Å–µ–∫?¬ª.
  
3. **–°–±–æ–π:**¬†–ï—Å–ª–∏ –Ω–µ—Ç ‚Äî —É–±–∏–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å (SIGKILL) –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –Ω–æ–≤—ã–π.
  

---

## 4. –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ (Refactored)

–¢–µ —Ñ–∞–π–ª—ã, –∫–æ—Ç–æ—Ä—ã–µ –º—ã –∏–∑–º–µ–Ω–∏–ª–∏ –∏ —É—Ç–≤–µ—Ä–¥–∏–ª–∏:

- `src/main.py`¬†‚Äî –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞. –ó–∞–ø—É—Å–∫–∞–µ—Ç –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä –∏ API.
  
- `src/core/orchestrator.py`¬†‚Äî –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞–º–∏ –∏ –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é.
  
- `src/hardware/camera_worker.py`¬†‚Äî –õ–æ–≥–∏–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ –∫–∞–º–µ—Ä—ã.
  
- `src/hardware/webcam.py`¬†‚Äî –ß–∏—Å—Ç—ã–π –¥—Ä–∞–π–≤–µ—Ä (—Ç–æ–ª—å–∫–æ –∑–∞—Ö–≤–∞—Ç).
  
- `src/core/processor.py`¬†‚Äî –ö–æ–Ω–≤–µ–π–µ—Ä –æ–±—Ä–∞–±–æ—Ç–∫–∏ (Pipeline) —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫ –ø–ª–∞–≥–∏–Ω–æ–≤.
  
- `src/data/shared_memory.py`¬†‚Äî –ù–æ–≤—ã–π –±–∏–Ω–∞—Ä–Ω—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª —Å –∑–∞—â–∏—Ç–æ–π.
  
- `src/api/server.py`¬†‚Äî –°–µ—Ä–≤–µ—Ä, —É–º–µ—é—â–∏–π —á–∏—Ç–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ç–æ–∫–æ–ª.








# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏ —Å–æ–∑–¥–∞–Ω–∏—é –≤–∏–¥–∂–µ—Ç–æ–≤


–í–æ—Ç –ø–æ–ª–Ω–∞—è, –æ–±—ä–µ–¥–∏–Ω–µ–Ω–Ω–∞—è –∏ –¥–æ–ø–æ–ª–Ω–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è. –û–Ω–∞ –≤–∫–ª—é—á–∞–µ—Ç –≤ —Å–µ–±—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –æ–±–∑–æ—Ä (–Ω–∞ –æ—Å–Ω–æ–≤–µ `architecture.md`) –∏ –ø–æ–¥—Ä–æ–±–Ω–æ–µ —Ä—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –ø–∞—Ä—ã ¬´–ü–ª–∞–≥–∏–Ω (–ë—ç–∫–µ–Ω–¥) + –í–∏–¥–∂–µ—Ç (–§—Ä–æ–Ω—Ç–µ–Ω–¥)¬ª, —É—á–∏—Ç—ã–≤–∞—è –≤—Å–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤–∞—à–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ (Registry, Wrappers, Context).

---

# üìò BikeFit Core v3.0: –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞

–î–∞–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–∏—Å—Ç–µ–º—ã BikeFit Core v3.0 (Secure Distributed Edition) –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –ø–æ—à–∞–≥–æ–≤—É—é –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –ø–æ —Å–æ–∑–¥–∞–Ω–∏—é –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π (–ø–ª–∞–≥–∏–Ω–æ–≤ –∏ –≤–∏–¥–∂–µ—Ç–æ–≤).

---

## –ß–∞—Å—Ç—å 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –°–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –∫–∞–∫ –Ω–∞–±–æ—Ä –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –æ–±–º–µ–Ω–∏–≤–∞—é—â–∏—Ö—Å—è –¥–∞–Ω–Ω—ã–º–∏ —á–µ—Ä–µ–∑ **Shared Memory** (–≤–∏–¥–µ–æ–ø–æ—Ç–æ–∫) –∏ **EventBus** (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ).

### 1.1. –û—Å–Ω–æ–≤–Ω—ã–µ –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **ProcessorOrchestrator (Main Process):**
* –£–ø—Ä–∞–≤–ª—è–µ—Ç –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º –≤–æ—Ä–∫–µ—Ä–æ–≤ –∫–∞–º–µ—Ä.
* **Security Controller:** –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç "—Å–æ–ª—å" (`MathSalt`) –¥–ª—è –∑–∞—â–∏—Ç—ã –¥–∞–Ω–Ω—ã—Ö –ø–∞–º—è—Ç–∏. –ë–µ–∑ —ç—Ç–æ–π —Å–æ–ª–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ –ø–∞–º—è—Ç–∏ —è–≤–ª—è—é—Ç—Å—è –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –º—É—Å–æ—Ä–æ–º.
* –ú–∞—Ä—à—Ä—É—Ç–∏–∑–∏—Ä—É–µ—Ç –∫–æ–º–∞–Ω–¥—ã –º–µ–∂–¥—É —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º –∏ –≤–æ—Ä–∫–µ—Ä–∞–º–∏.


2. **CameraWorker (Process per Camera):**
* –ó–∞—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–¥—Ä—ã.
* –ó–∞–ø—É—Å–∫–∞–µ—Ç **Processor** (–ø–∞–π–ø–ª–∞–π–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏).
* –°–æ—Ö—Ä–∞–Ω—è–µ—Ç "–æ—Ç—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ" (–∑–∞—â–∏—â–µ–Ω–Ω—ã–µ) –¥–∞–Ω–Ω—ã–µ –≤ Shared Memory.


3. **Processor (Pipeline Engine):**
* –ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç **–ü–ª–∞–≥–∏–Ω—ã (Stages)**.
* –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Ç –≤—Å–µ—Ö –ø–ª–∞–≥–∏–Ω–æ–≤ –≤ –µ–¥–∏–Ω—ã–π `FrameContext`.
* –§–æ—Ä–º–∏—Ä—É–µ—Ç JSON-—Å–Ω–∞–ø—à–æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è (`SystemState`) –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –Ω–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥.


4. **APIServer & WebSocket:**
* –¢—Ä–∞–Ω—Å–ª–∏—Ä—É–µ—Ç –≤–∏–¥–µ–æ (MJPEG).
* –û–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –¥–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—é—é —Å–≤—è–∑—å —á–µ—Ä–µ–∑ WebSocket:
* **Downstream:** –ë—ç–∫–µ–Ω–¥ -> –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–î–∞–Ω–Ω—ã–µ –≤–∏–¥–∂–µ—Ç–æ–≤, —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è).
* **Upstream:** –§—Ä–æ–Ω—Ç–µ–Ω–¥ -> –ë—ç–∫–µ–Ω–¥ (–ö–æ–º–∞–Ω–¥—ã –∫–Ω–æ–ø–æ–∫).





### 1.2. –ü–æ—Ç–æ–∫ –î–∞–Ω–Ω—ã—Ö (Data Flow)

1. **–ë—ç–∫–µ–Ω–¥:** –ü–ª–∞–≥–∏–Ω –≤—ã–∑—ã–≤–∞–µ—Ç `ctx.ui.update_widget(...)`.
2. **Processor:** –°–æ–±–∏—Ä–∞–µ—Ç —ç—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤ —Å–ø–∏—Å–æ–∫ `widgets`.
3. **EventBus:** –ü–µ—Ä–µ–¥–∞–µ—Ç –ø–∞–∫–µ—Ç –û—Ä–∫–µ—Å—Ç—Ä–∞—Ç–æ—Ä—É, –∑–∞—Ç–µ–º API —Å–µ—Ä–≤–µ—Ä—É.
4. **WebSocket:** –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –≤ –±—Ä–∞—É–∑–µ—Ä. `wsRef.current.send(JSON.stringify({ target: targetOverride || targetId, payload: { cmd, args }  // <--- –í–õ–û–ñ–ï–ù–ù–û–°–¢–¨!}));`
5. **Frontend (RobotContext):** –†–∞—Å–ø–∞–∫–æ–≤—ã–≤–∞–µ—Ç JSON –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–µ–π—Ç `widgetsData`.
6. **Registry (Wrapper):** –î–æ—Å—Ç–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ ID –∏ –ø–µ—Ä–µ–¥–∞–µ—Ç –∏—Ö –≤ React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç.

---

## –ß–∞—Å—Ç—å 2. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –°–æ–∑–¥–∞–Ω–∏–µ –ü–ª–∞–≥–∏–Ω–∞ (Backend)

–ü–ª–∞–≥–∏–Ω ‚Äî —ç—Ç–æ Python-–∫–ª–∞—Å—Å, –∫–æ—Ç–æ—Ä—ã–π –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤–∏–¥–µ–æ –∏–ª–∏ –ª–æ–≥–∏–∫—É.

**–ì–¥–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å:** `src/plugins/` (—Å–∏—Å—Ç–µ–º–∞ —Å–∞–º–∞ –Ω–∞–π–¥–µ—Ç —Ñ–∞–π–ª).

### –®–∞–±–ª–æ–Ω –ü–ª–∞–≥–∏–Ω–∞

```python
from src.core.pipeline import PipelineStage, FrameContext
from loguru import logger
import time

class MyFeaturePlugin(PipelineStage):
    def __init__(self):
        # –ò–º—è –ø–ª–∞–≥–∏–Ω–∞. –û–Ω–æ –∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ target –¥–ª—è –∫–æ–º–∞–Ω–¥.
        super().__init__("my_feature") 
        self.counter = 0

    def process(self, ctx: FrameContext):
        """–í—ã–∑—ã–≤–∞–µ—Ç—Å—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–∞–¥—Ä–∞"""
        
        # 1. –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
        # ctx.frame - —Ç–µ–∫—É—â–∏–π –∫–∞–¥—Ä (numpy array)
        # ctx.config - –∫–æ–Ω—Ñ–∏–≥ –∫–∞–º–µ—Ä—ã
        
        # 2. –õ–æ–≥–∏–∫–∞ (–ø—Ä–∏–º–µ—Ä)
        self.counter += 1
        
        # 3. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –§—Ä–æ–Ω—Ç–µ–Ω–¥ (–≤ –í–∏–¥–∂–µ—Ç)
        # widget_id: ID, –ø–æ –∫–æ—Ç–æ—Ä–æ–º—É –≤–∏–¥–∂–µ—Ç –Ω–∞–π–¥–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Registry
        payload = {
            "val": self.counter,
            "status": "active"
        }
        ctx.ui.update_widget(widget_id="my_feature_widget", title="My Feature", data=payload)

    def handle_command(self, cmd: str, args: dict):
        """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥ –æ—Ç –∫–Ω–æ–ø–æ–∫ –≤–∏–¥–∂–µ—Ç–∞"""
        logger.info(f"üì® MyFeature received: {cmd}")
        
        if cmd == "reset":
            self.counter = 0

```

### –ü—Ä–∞–≤–∏–ª–∞ –ë—ç–∫–µ–Ω–¥–∞:

1. **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ:** –í—Å–µ–≥–¥–∞ –Ω–∞—Å–ª–µ–¥—É–π—Ç–µ—Å—å –æ—Ç `PipelineStage`.
2. **UI Updates:** –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `ctx.ui.update_widget`, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É –≤–∏–¥–∂–µ—Ç—É.
3. **Commands:** –†–µ–∞–ª–∏–∑—É–π—Ç–µ –º–µ—Ç–æ–¥ `handle_command` –¥–ª—è —Ä–µ–∞–∫—Ü–∏–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏.

---

## –ß–∞—Å—Ç—å 3. –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ: –°–æ–∑–¥–∞–Ω–∏–µ –í–∏–¥–∂–µ—Ç–∞ (Frontend)

–í–∏–¥–∂–µ—Ç ‚Äî —ç—Ç–æ React-–∫–æ–º–ø–æ–Ω–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–æ–º–∞–Ω–¥—ã.

**–ì–¥–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å:** `src/components/` (–∏–ª–∏ `src/widgets/`).

### –®–∞–±–ª–æ–Ω –í–∏–¥–∂–µ—Ç–∞

```jsx
import React from 'react';

// –í–∏–¥–∂–µ—Ç –ø–æ–ª—É—á–∞–µ—Ç –¥–≤–∞ –ø—Ä–æ–ø—Å–∞:
// data - –æ–±—ä–µ–∫—Ç –¥–∞–Ω–Ω—ã—Ö, –ø—Ä–∏—à–µ–¥—à–∏–π —Å –±—ç–∫–µ–Ω–¥–∞
// sendCommand - —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥
export const MyFeatureWidget = ({ data, sendCommand }) => {
    
    // 1. –†–∞—Å–ø–∞–∫–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö (Safety Check)
    // RobotContext –æ–±–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ, –ø–æ—ç—Ç–æ–º—É –±–µ—Ä–µ–º .data –∏–ª–∏ —Å–∞–º –æ–±—ä–µ–∫—Ç
    const payload = data?.data || data || {};
    
    const value = payload.val || 0;
    const status = payload.status || 'Loading...';

    // 2. –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã
    const handleReset = () => {
        console.log("Sending reset...");
        // target: –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å –∏–º–µ–Ω–µ–º –ø–ª–∞–≥–∏–Ω–∞ –≤ Python (super().__init__("my_feature"))
        // cmd: –∏–º—è –∫–æ–º–∞–Ω–¥—ã
        // args: –ª—é–±—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
        if (sendCommand) {
            sendCommand('my_feature', 'reset', {}); 
        }
    };

    return (
        <div style={{ padding: 20, color: 'white', background: '#1e293b' }}>
            <h3>My Feature</h3>
            <div>Value: {value}</div>
            <div>Status: {status}</div>
            
            <button onClick={handleReset}>Reset Counter</button>
        </div>
    );
};

```

### –ü—Ä–∞–≤–∏–ª–∞ –§—Ä–æ–Ω—Ç–µ–Ω–¥–∞:

1. **–†–∞—Å–ø–∞–∫–æ–≤–∫–∞:** –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏—é `const payload = data?.data || {};`, —Ç–∞–∫ –∫–∞–∫ –¥–∞–Ω–Ω—ã–µ –º–æ–≥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –≤ –æ–±–µ—Ä—Ç–∫–µ.
2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ sendCommand:** –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º.
3. **Target:** –ü–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç `sendCommand` ‚Äî —ç—Ç–æ –∏–º—è –ø–ª–∞–≥–∏–Ω–∞ –Ω–∞ –±—ç–∫–µ–Ω–¥–µ.

---

## –ß–∞—Å—Ç—å 4. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (–°–≤—è–∑—ã–≤–∞–Ω–∏–µ –ë—ç–∫–∞ –∏ –§—Ä–æ–Ω—Ç–∞)

–ß—Ç–æ–±—ã –≤–∏–¥–∂–µ—Ç –ø–æ—è–≤–∏–ª—Å—è –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ –∏ –ø–æ–ª—É—á–∏–ª –¥–æ—Å—Ç—É–ø –∫ –¥–∞–Ω–Ω—ã–º, –µ–≥–æ –Ω—É–∂–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `registry.js` —á–µ—Ä–µ–∑ **Wrapper (–û–±–µ—Ä—Ç–∫—É)**.

**–§–∞–π–ª:** `src/widgets/registry.js`

### –ü–æ—á–µ–º—É –Ω—É–∂–µ–Ω Wrapper?

React-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ `react-grid-layout`, –∫–æ—Ç–æ—Ä—É—é –º—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º, –Ω–µ —É–º–µ–µ—Ç —Å–∞–º–∞ –ø—Ä–æ–∫–∏–¥—ã–≤–∞—Ç—å –ø—Ä–æ–ø—Å—ã (`data`, `sendCommand`) –≤ –≤–∏–¥–∂–µ—Ç—ã. –ú—ã –¥–æ–ª–∂–Ω—ã —Å–¥–µ–ª–∞—Ç—å —ç—Ç–æ –≤—Ä—É—á–Ω—É—é, –ø–æ–¥–∫–ª—é—á–∏–≤—à–∏—Å—å –∫ `RobotContext`.

### –®–∞–≥ 1. –°–æ–∑–¥–∞–Ω–∏–µ Wrapper-–∞

–î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ—Ç –∫–æ–¥ –≤ `registry.js` –ø–µ—Ä–µ–¥ —ç–∫—Å–ø–æ—Ä—Ç–æ–º `WIDGET_REGISTRY`:

```javascript
import { MyFeatureWidget } from '../components/MyFeatureWidget'; // –ò–º–ø–æ—Ä—Ç –≤–∞—à–µ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
import { useRobot } from '../context/RobotContext';

// ... –¥—Ä—É–≥–∏–µ –∏–º–ø–æ—Ä—Ç—ã ...

// –°–æ–∑–¥–∞–µ–º —Å–≤—è–∑—É—é—â–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç
const MyFeatureWrapper = () => {
    const { sendCommand, widgetsData } = useRobot();
    const TARGET_ID = 'my_feature_widget'; // ID –¥–æ–ª–∂–µ–Ω —Å–æ–≤–ø–∞–¥–∞—Ç—å —Å Python
    const data = widgetsData[TARGET_ID] || {};
    
    // ‚úÖ Best Practice: –°–æ–∑–¥–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫, –∫–æ—Ç–æ—Ä–∞—è –∑–Ω–∞–µ—Ç ID –ø–ª–∞–≥–∏–Ω–∞
    const sendToPlugin = (cmd, args = {}) => {
        if (sendCommand) sendCommand(TARGET_ID, cmd, args);
    };
    
    return <MyFeatureWidget data={data} sendCommand={sendToPlugin} />;
};

```

### –®–∞–≥ 2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ Registry

–î–æ–±–∞–≤—å—Ç–µ –∑–∞–ø–∏—Å—å –≤ –æ–±—ä–µ–∫—Ç `WIDGET_REGISTRY`:

```javascript
export const WIDGET_REGISTRY = {
    // ... –¥—Ä—É–≥–∏–µ –≤–∏–¥–∂–µ—Ç—ã ...
    
    'my_feature_ui': {           // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –ª–µ–π–∞—É—Ç–æ–≤
        title: 'Super Feature',  // –ó–∞–≥–æ–ª–æ–≤–æ–∫ –æ–∫–Ω–∞
        component: MyFeatureWrapper, // –ò—Å–ø–æ–ª—å–∑—É–µ–º Wrapper, –∞ –Ω–µ —Å–∞–º Widget!
        defaultW: 4,             // –®–∏—Ä–∏–Ω–∞ (–≤ –∫–æ–ª–æ–Ω–∫–∞—Ö —Å–µ—Ç–∫–∏)
        defaultH: 6              // –í—ã—Å–æ—Ç–∞
    }
};

```

---

## –ß–µ–∫-–ª–∏—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ "–ü–æ—á–µ–º—É –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç?"

1. **–î–∞–Ω–Ω—ã–µ –Ω–µ –ø—Ä–∏—Ö–æ–¥—è—Ç:**
* –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `widget_id` –≤ Python (`ctx.ui.update_widget`) –∏ –≤ `registry.js` (`widgetsData['...']`). –û–Ω–∏ –¥–æ–ª–∂–Ω—ã —Å–æ–≤–ø–∞–¥–∞—Ç—å **–±—É–∫–≤–∞ –≤ –±—É–∫–≤—É**.
* –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –ø–ª–∞–≥–∏–Ω –∑–∞–≥—Ä—É–∂–µ–Ω (–≤ –ª–æ–≥–∞—Ö –±—ç–∫–µ–Ω–¥–∞: `üîå Discovered Plugin`).


2. **–ö–æ–º–∞–Ω–¥—ã –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç:**
* –û—à–∏–±–∫–∞ `sendCommand is not a function`? -> –í—ã –∑–∞–±—ã–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **Wrapper** –≤ `registry.js` –∏–ª–∏ –Ω–µ –ø–µ—Ä–µ–¥–∞–ª–∏ `sendCommand` –≤ –ø—Ä–æ–ø—Å—ã.
* –ö–æ–º–∞–Ω–¥–∞ —É—Ö–æ–¥–∏—Ç, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç? -> –ü—Ä–æ–≤–µ—Ä—å—Ç–µ `target` –≤ `sendCommand('TARGET', ...)` –∏ –∏–º—è –≤ `super().__init__("TARGET")`.


3. **–ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è:**
* –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Python –≤—ã —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç–µ —Å—Ç—Ä–æ–∫—É `data:image/jpeg;base64,...`.
* –í React –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `<img src={payload.image_src} />`.



## ‚ö° –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –ø–ª–∞–≥–∏–Ω–æ–≤: Best Practices (v2.1)

### 1. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ä–µ—Å—É—Ä—Å–∞–º–∏ (Throttling)

–°–∏—Å—Ç–µ–º–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ 90 FPS. –¢—è–∂–µ–ª—ã–µ CV-–∞–ª–≥–æ—Ä–∏—Ç–º—ã (–ø–æ–∏—Å–∫ –º–∞—Ä–∫–µ—Ä–æ–≤, –Ω–µ–π—Ä–æ—Å–µ—Ç–∏)¬†**–Ω–µ –¥–æ–ª–∂–Ω—ã**¬†–∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –Ω–∞ –∫–∞–∂–¥–æ–º –∫–∞–¥—Ä–µ, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è —Ç—Ä–µ–∫–∏–Ω–≥–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç—Ä–æ—Ç—Ç–ª–∏–Ω–≥:

Python

```
self.FPS_PROCESS = 15.0 # –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è UI/–ù–∞—Å—Ç—Ä–æ–π–∫–∏
if (time.time() - self.last_time) < (1.0 / self.FPS_PROCESS):
    return
```

### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ–º–∞–Ω–¥ (EventBus)

–î–ª—è –æ–±—â–µ–Ω–∏—è —Å Hardware-–≤–æ—Ä–∫–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–æ–¥¬†`send_command`¬†—Å —Ç—Ä–µ–º—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞–º–∏.¬†**–ó–∞–ø—Ä–µ—â–µ–Ω–æ**—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å payload –≤—Ä—É—á–Ω—É—é.

Python

```
# ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ:
ctx.bus.send_command(f"cam_{ctx.camera_id}", "SET_CONFIG", {"gain": 10})

# ‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ:
ctx.bus.send_command(0, {"cmd": "SET_CONFIG", "args": ...})
```

### 3. –§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞

–í—Å–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –ø–ª–∞–≥–∏–Ω–æ–≤ –¥–æ–ª–∂–Ω—ã —Ö—Ä–∞–Ω–∏—Ç—å—Å—è –≤ –ø–∞–ø–∫–µ¬†`/config`¬†–≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞. –î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø—É—Ç—è–º –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é:

Python

```
from src.core.config import ROOT_DIR
config_path = ROOT_DIR / "config" / "plugin_name.json"
```

### 4. –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª (Lifecycle)

–ï—Å–ª–∏ –≤–∞—à –ø–ª–∞–≥–∏–Ω –∏–º–µ–µ—Ç UI (–≤–∏–¥–∂–µ—Ç), –æ–Ω –¥–æ–ª–∂–µ–Ω —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Å–∫—Ä—ã—Ç–∏–µ –æ–∫–Ω–∞, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç—Ä–µ–±–ª—è—Ç—å —Ä–µ—Å—É—Ä—Å—ã. –†–µ–∞–ª–∏–∑—É–π—Ç–µ –≤¬†`handle_command`:

- `wizard_opened`¬†-> –í–∫–ª—é—á–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏ —Å—Ç—Ä–∏–º–∏–Ω–≥.
  
- `wizard_closed`¬†-> –í—ã–∫–ª—é—á–∏—Ç—å –≤—Å–µ (`return`¬†–≤ –Ω–∞—á–∞–ª–µ¬†`process`).
  
- `toggle_pause`¬†-> –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—á–µ—Ç—ã, –Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å —Å—Ç—Ä–∏–º–∏–Ω–≥ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)