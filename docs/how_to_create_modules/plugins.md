# ๐ ะัะบะพะฒะพะดััะฒะพ ะะฐะทัะฐะฑะพััะธะบะฐ: ะะพะดัะปะธ ะธ ะะปะฐะณะธะฝั (v3.0)

## 1. ะคะธะปะพัะพัะธั ะััะธัะตะบัััั

ะกะธััะตะผะฐ BikeFit Motion ัะฐะฑะพัะฐะตั ะบะฐะบย**ะะพะฝะฒะตะนะตั (Pipeline)**ยะฒะฝัััะธ ะธะทะพะปะธัะพะฒะฐะฝะฝะพะณะพ ะฟัะพัะตััะฐ ะบะฐะผะตัั (`CameraWorker`). ะะฐะถะดัะน ะบะฐะดั ะฟัะพัะพะดะธั ัะตัะตะท ัะตะฟะพัะบั ะฝะตะทะฐะฒะธัะธะผัั ะฑะปะพะบะพะฒ โย**ะกัะฐะดะธะน (Stages)**.

### ะงะตะผ ะพัะปะธัะฐะตััั ะะพะดัะปั ะฏะดัะฐ ะพั ะะปะฐะณะธะฝะฐ?

ะฅะพัั ัะตัะฝะธัะตัะบะธ ััะพ ะพะดะธะฝ ะธ ัะพั ะถะต ะบะปะฐัั, ะธั ัะพะปะธ ัััะพะณะพ ัะฐะทะดะตะปะตะฝั:

| ะฅะฐัะฐะบัะตัะธััะธะบะฐ | **ะะพะดัะปั ะฏะดัะฐ (Core Stage)** | **ะะปะฐะณะธะฝ (Plugin)** |
| --- | --- | --- |
| **ะะฐัะฟะพะปะพะถะตะฝะธะต** | `src/stages/` | `src/plugins/` |
| **ะะฐะณััะทะบะฐ** | ะะตััะบะพ ะฟัะพะฟะธัะฐะฝ ะฒย`CORE_PIPELINE`(`config.py`). | ะกะบะฐะฝะธััะตััั ะฐะฒัะพะผะฐัะธัะตัะบะธ ะฟัะธ ััะฐััะต. |
| **ะะฐะดะฐัะฐ** | **ะะตะฝะตัะฐัะธั ะดะฐะฝะฝัั.**ยะัะตะฒัะฐัะฐะตั ััััั ะบะฐััะธะฝะบั ะฒ ะบะพะพัะดะธะฝะฐัั, ััััะฐะฝัะตั ะธัะบะฐะถะตะฝะธั. | **ะะพััะตะฑะปะตะฝะธะต ะดะฐะฝะฝัั.**ยะะฝะฐะปะธะทะธััะตั ะบะพะพัะดะธะฝะฐัั, ัะธััะตั ะณัะฐัะธะบะธ, ััะธัะฐะตั ัะณะปั. |
| **ะะพัััะฟ** | ะะผะตะตั ะฟัะฐะฒะพย**ะธะทะผะตะฝััั**ยะธััะพะดะฝัะน ะบะฐะดั (Undistort, Filters). | ะะฐะฑะพัะฐะตั ะฒ ัะตะถะธะผะตย**Read-Only**ย(ะฝะต ะดะพะปะถะตะฝ ะผะตะฝััั ะบะฐะดั). |
| **ะัะบะฐะทะพัััะพะนัะธะฒะพััั** | ะัะปะธ ัะฟะฐะดะตั โ ัะธััะตะผะฐ ะผะพะถะตั ะฟะพัะตัััั ััะตะบะธะฝะณ. | ะัะปะธ ัะฟะฐะดะตั โ ะฟัะพััะพ ะพัะบะปััะธััั, ะฒะธะดะตะพ ะฟัะพะดะพะปะถะธััั. |

---

## 2. ะะฝะฐัะพะผะธั ะะพะดัะปั

ะัะฑะพะน ะผะพะดัะปั โ ััะพ ะบะปะฐัั, ะฝะฐัะปะตะดัะตะผัะน ะพัย`PipelineStage`.

### ะะฐะทะพะฒะฐั ััััะบัััะฐ

Python

```
from src.core.pipeline import PipelineStage, FrameContext

class MySuperModule(PipelineStage):
    def __init__(self):
        # 1. ะะผั ะผะพะดัะปั (ะดะพะปะถะฝะพ ะฑััั ัะฝะธะบะฐะปัะฝัะผ)
        super().__init__(name="my_super_module")
        self.param = 42  # ะะฝัััะตะฝะฝะตะต ัะพััะพัะฝะธะต

    def process(self, ctx: FrameContext):
        # 2. ะัะฝะพะฒะฝะฐั ะปะพะณะธะบะฐ (ะฒัะทัะฒะฐะตััั 90 ัะฐะท ะฒ ัะตะบัะฝะดั)
        if ctx.frame is None:
            return

        # ะงะธัะฐะตะผ ะดะฐะฝะฝัะต ะพั ะฟัะตะดัะดััะธั ะผะพะดัะปะตะน
        points = ctx.get_data("vision", "keypoints")

        # ะะตะปะฐะตะผ ะผะฐะณะธั
        result = self._do_magic(points)

        # ะะธัะตะผ ัะตะทัะปััะฐั ะดะปั ัะปะตะดัััะธั ะผะพะดัะปะตะน
        ctx.set_data("my_module", "result", result)

        # 3. ะะฑะฝะพะฒะปัะตะผ UI (ะพัะฟัะฐะฒะปัะตะผ ะฒะธะดะถะตัั ะฝะฐ ััะพะฝั)
        ctx.ui.update_widget("magic_stat", "Magic Level", result)

    def handle_command(self, cmd: str, args: dict):
        # 4. ะฃะฟัะฐะฒะปะตะฝะธะต ะธะทะฒะฝะต (ะบะฝะพะฟะบะธ/ะฟะพะปะทัะฝะบะธ ะฝะฐ ััะพะฝัะต)
        if cmd == "set_param":
            self.param = args.get("value", 42)
```

---

## 3. ะัะฐะฒะธะปะฐ ะะทะฐะธะผะพะดะตะนััะฒะธั (The Contract)

ะะพะดัะปัย**ะพะฑัะทะฐะฝ**ยัะพะฑะปัะดะฐัั ัะปะตะดัััะธะต ะฟัะฐะฒะธะปะฐ, ััะพะฑั ัะธััะตะผะฐ ัะฐะฑะพัะฐะปะฐ ััะฐะฑะธะปัะฝะพ.

### 3.1. ะกะธะณะฝะฐะป "ะฏ ะะธะฒ" (Heartbeat & Performance)

ะะฐะผย**ะฝะต ะฝัะถะฝะพ**ยะฒัััะฝัั ะพัะฟัะฐะฒะปััั ะฟะธะฝะณ. ะะฒะธะถะพะบย`Processor`:

1. ะะฒัะพะผะฐัะธัะตัะบะธ ะทะฐะผะตััะตั ะฒัะตะผั ะฒัะฟะพะปะฝะตะฝะธั ะฒะฐัะตะณะพย`process()`.
  
2. ะัะปะธ ะผะตัะพะดย`process`ยะฒัะฟะพะปะฝัะตััั ะดะพะปััะต 100ะผั, ะผะพะดัะปั ะฟะพะผะตัะฐะตััั ะบะฐะบ "ะผะตะดะปะตะฝะฝัะน".
  
3. ะัะปะธ ะผะตัะพะด ะฒัะทัะฒะฐะตั ะธัะบะปััะตะฝะธะต (`Exception`), ะดะฒะธะถะพะบ ะปะพะฒะธั ะตะณะพ, ัะฒะตะปะธัะธะฒะฐะตั ััะตััะธะบ ะพัะธะฑะพะบ ะธ ัะปะตั ะฐะปะตัั ะฝะฐ ััะพะฝั.
  
4. **Circuit Breaker:**ยะัะปะธ ะผะพะดัะปั ะฟะฐะดะฐะตั 10 ัะฐะท ะฟะพะดััะด, ะดะฒะธะถะพะบ ะพัะบะปััะฐะตั ะตะณะพ (`is_active = False`), ััะพะฑั ัะฟะฐััะธ ะพััะฐะปัะฝัั ัะธััะตะผั.
  

### 3.2. ะะฐะฑะพัะฐ ั ะดะฐะฝะฝัะผะธ (`FrameContext`)

ะะพะฝัะตะบััย`ctx`ยโ ััะพ ะตะดะธะฝััะฒะตะฝะฝัะน ัะฟะพัะพะฑ ะพะฑัะตะฝะธั.

- **ะงัะตะฝะธะต:**ย`ctx.get_data(namespace, key, default)`
  
- **ะะฐะฟะธัั:**ย`ctx.set_data(namespace, key, value)`
  
- **ะัะธะฑะบะธ:**ย`ctx.add_error(source, message)`ยโ ะฟะพะบะฐะถะตั ะบัะฐัะฝัะน ัะพัั ะฝะฐ ััะพะฝัะต.
  

**ะกัะฐะฝะดะฐััะฝัะต ะฟัะพัััะฐะฝััะฒะฐ ะธะผะตะฝ (Namespaces):**

- `vision`: ะกัััะต ัะตะทัะปััะฐัั CV (keypoints, contours).
  
- `marker_manager`: ะะผะตะฝะพะฒะฐะฝะฝัะต ะผะฐัะบะตัั (hip, knee, ankle).
  
- `geometry`: ะะฐัััะธัะฐะฝะฝัะต ัะณะปั ะธ ะปะธะฝะธะธ.
  

### 3.3. ะะฑัะฐัะฝะฐั ัะฒัะทั ั UI (`ctx.ui`)

ะะพะดัะปั ะฝะต ะดะพะปะถะตะฝ ะธัะฟะพะปัะทะพะฒะฐััย`print()`. ะะฝ ะดะพะปะถะตะฝ ัะปะฐัั ะดะฐะฝะฝัะต ะฒ UI.

Python

```
# 1. ะัะฟัะฐะฒะธัั ัะฒะตะดะพะผะปะตะฝะธะต (ะฒัะฟะปัะฒะฐัะบะฐ)
ctx.ui.notify("Calibration Done", "Success!", level="success")

# 2. ะะฑะฝะพะฒะธัั ะฒะธะดะถะตั (ัะตะบัั, ะณัะฐัะธะบ, ะธะฝะดะธะบะฐัะพั)
ctx.ui.update_widget(
    widget_id="fps_widget",
    title="Real FPS",
    data="90.5",
    w_type="text"
)
```

### 3.4. ะฃะฟัะฐะฒะปะตะฝะธะต (`handle_command`)

ะัะปะธ ะฒั ัะพัะธัะต, ััะพะฑั ะผะพะดัะปะตะผ ะผะพะถะฝะพ ะฑัะปะพ ัะฟัะฐะฒะปััั ั ััะพะฝัะฐ:

1. ะะตะฐะปะธะทัะนัะต ะผะตัะพะดย`handle_command(self, cmd, args)`.
  
2. ะะฐ ััะพะฝัะตะฝะดะต ะพัะฟัะฐะฒััะต WebSocket ัะพะพะฑัะตะฝะธะต:
  
  JSON
  
  ```
  {
   "target": "my_super_module",
   "cmd": "set_param",
   "args": { "value": 100 }
  }
  ```
  

---

## 4. ะัะธะผะตั ะะตะฐะปะธะทะฐัะธะธ

### ะัะธะผะตั 1: ะะพะดัะปั ะฏะดัะฐ (ะะตัะตะบัะพั)

*ะะฐะดะฐัะฐ: ะะฐะนัะธ ะฑะตะปัะต ะฟััะฝะฐ.*

Python

```
# src/stages/detection.py
import cv2
from src.core.pipeline import PipelineStage, FrameContext
from src.data.models import Point2D

class BlobDetector(PipelineStage):
    def __init__(self):
        super().__init__(name="blob_detector")
        # ะญัะธ ะฟะฐัะฐะผะตััั ะผะพะถะฝะพ ะผะตะฝััั ัะตัะตะท handle_command
        self.min_area = 10 

    def process(self, ctx: FrameContext):
        # 1. ะะตัะตะผ ะฝะฐัััะพะนะบะธ ะธะท ะณะปะพะฑะฐะปัะฝะพะณะพ ะบะพะฝัะธะณะฐ (ะตัะปะธ ััะพ Core)
        thresh = ctx.config.threshold or 200

        # 2. ะะฐัะตะผะฐัะธะบะฐ
        gray = cv2.cvtColor(ctx.frame, cv2.COLOR_BGR2GRAY)
        _, bin_img = cv2.threshold(gray, thresh, 255, cv2.THRESH_BINARY)
        contours, _ = cv2.findContours(bin_img, cv2.RETR_EXTERNAL, cv2.CHAIN_APPROX_SIMPLE)

        points = []
        for cnt in contours:
            if cv2.contourArea(cnt) > self.min_area:
                M = cv2.moments(cnt)
                if M["m00"]:
                    cx = int(M["m10"] / M["m00"])
                    cy = int(M["m01"] / M["m00"])
                    points.append(Point2D(x=cx, y=cy))

        # 3. ะัะฑะปะธะบะฐัะธั ะดะฐะฝะฝัั (ะะะะขะะงะะ ะดะปั ัะปะตะดัััะธั ััะฐะดะธะน)
        ctx.set_data("vision", "keypoints", points)

        # 4. ะะธะดะถะตั ัะพััะพัะฝะธั
        ctx.ui.update_widget("blobs_count", "Markers", len(points), "status_indicator")

    def handle_command(self, cmd, args):
        if cmd == "set_min_area":
            self.min_area = args.get("value")
```

### ะัะธะผะตั 2: ะะปะฐะณะธะฝ (ะะฝะฐะปะธัะธะบะฐ)

*ะะฐะดะฐัะฐ: ะกัะธัะฐัั ะฟััะถะบะธ ะฒะตะปะพัะธะฟะตะดะธััะฐ (ะฒะตััะธะบะฐะปัะฝัะต ะบะพะปะตะฑะฐะฝะธั).*

Python

```
# src/plugins/vertical_oscillation.py
from src.core.pipeline import PipelineStage, FrameContext

class VerticalOscillationPlugin(PipelineStage):
    def __init__(self):
        super().__init__(name="vert_oscillation")
        self.history = []

    def process(self, ctx: FrameContext):
        # 1. ะงะธัะฐะตะผ ัะถะต ะณะพัะพะฒัะต ะธะผะตะฝะพะฒะฐะฝะฝัะต ะผะฐัะบะตัั
        markers = ctx.get_data("marker_manager", "markers")
        if not markers or "hip" not in markers:
            return

        hip_y = markers["hip"].y
        self.history.append(hip_y)
        if len(self.history) > 90: self.history.pop(0)

        # 2. ะกัะธัะฐะตะผ ะฐะผะฟะปะธััะดั
        amplitude = max(self.history) - min(self.history)

        # 3. ะะธััะตะผ ะณัะฐัะธะบ ะฝะฐ ััะพะฝัะต
        ctx.ui.update_widget(
            widget_id="oscillation_chart",
            title="Hip Oscillation (px)",
            data=self.history, 
            w_type="chart_line"  # ะคัะพะฝั ัะฐะผ ะฝะฐัะธััะตั ะณัะฐัะธะบ
        )
```

---

## 5. ะงะตะบ-ะปะธัั ัะฐะทัะฐะฑะพััะธะบะฐ

ะะตัะตะด ัะตะผ ะบะฐะบ ะทะฐะบะพะผะผะธัะธัั ะฝะพะฒัะน ะผะพะดัะปั, ะฟัะพะฒะตัั:

1. [ ]ย**ะะฐัะปะตะดะพะฒะฐะฝะธะต:**ยะะปะฐัั ะฝะฐัะปะตะดัะตััั ะพัย`PipelineStage`?
  
2. [ ]ย**ะะผั:**ยะะตัะตะดะฐะฝะพ ะปะธ ัะฝะธะบะฐะปัะฝะพะต ะธะผั ะฒย`super().__init__`?
  
3. [ ]ย**ะะตะทะพะฟะฐัะฝะพััั:**ยะััั ะปะธ ะฟัะพะฒะตัะบะฐย`if ctx.frame is None`?
  
4. [ ]ย**ะะฐะฝะฝัะต:**ยะัะฟะพะปัะทัะตััั ะปะธย`ctx.get_data`ย/ย`ctx.set_data`ยะฒะผะตััะพ ะณะปะพะฑะฐะปัะฝัั ะฟะตัะตะผะตะฝะฝัั?
  
5. [ ]ย**ะะพะผะฐะฝะดั:**ยะัะปะธ ะตััั ะฝะฐัััะพะนะบะธ, ัะตะฐะปะธะทะพะฒะฐะฝ ะปะธย`handle_command`?
  
6. [ ]ย**ะงะธััะพัะฐ:**ยะะพะดัะปั ะะ ะดะพะปะถะตะฝ ะดะตะปะฐััย`print`ย(ะธัะฟะพะปัะทัะนย`logger`ยะธะปะธย`ctx.ui`).
  
7. [ ]ย**ะกะบะพัะพััั:**ยะะตั ะปะธ ััะถะตะปัั ะฑะปะพะบะธััััะธั ะพะฟะตัะฐัะธะน (ะทะฐะฟัะพัั ะฒ ัะตัั, sleep)? ะัะปะธ ะตััั โ ะฒัะฝะพัะธ ะฒย`AsyncStageRunner`.