# BikeFit Core v3.0: Architecture & Plugin Guide

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –ø—Ä–æ—Ç–æ–∫–æ–ª–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –ø—Ä–∞–≤–∏–ª —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –ø–ª–∞–≥–∏–Ω–æ–≤.
**–ê–∫—Ç—É–∞–ª—å–Ω–æ –Ω–∞:** –Ø–Ω–≤–∞—Ä—å 2026
**–í–µ—Ä—Å–∏—è —è–¥—Ä–∞:** v3.0 (Multiprocess + SharedMemory + EventBus)

---

## 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –°–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ —Ç—Ä–µ—Ö –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø—Ä–æ—Ü–µ—Å—Å–æ–≤, –æ–±—â–∞—é—â–∏—Ö—Å—è —á–µ—Ä–µ–∑ **Shared Memory** (–≤–∏–¥–µ–æ) –∏ **EventBus** (–∫–æ–º–∞–Ω–¥—ã/–¥–∞–Ω–Ω—ã–µ).

### 1.1. –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1.  **Frontend (React):**
    * –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–µ–æ (Canvas 60fps).
    * –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ (WebSocket).
    * **Optimistic UI:** –°–ª–∞–π–¥–µ—Ä—ã –∏ –∫–Ω–æ–ø–∫–∏ –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –∑–∞–¥–µ—Ä–∂–∫—É —Å–µ—Ç–∏ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ö—É–∫ `useOptimisticValue`), —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ñ–æ–Ω–µ.

2.  **Backend API (FastAPI):**
    * –î–µ—Ä–∂–∏—Ç WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.
    * –ü–µ—Ä–µ–∫–ª–∞–¥—ã–≤–∞–µ—Ç JSON-–∫–æ–º–∞–Ω–¥—ã –æ—Ç –§—Ä–æ–Ω—Ç–∞ –≤ `EventBus` (Queue).
    * –ß–∏—Ç–∞–µ—Ç –≥–æ—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ `EventBus` –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –§—Ä–æ–Ω—Ç.

3.  **Camera Worker (Process):**
    * **–í–ª–∞–¥–µ–ª–µ—Ü –ø—Ä–æ—Ü–µ—Å—Å–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏.**
    * –£–ø—Ä–∞–≤–ª—è–µ—Ç "–∂–µ–ª–µ–∑–æ–º" (Webcam/Drivers).
    * –ó–∞–ø—É—Å–∫–∞–µ—Ç `Processor` (–∫–æ–Ω–≤–µ–π–µ—Ä —Å—Ç–∞–¥–∏–π).
    * **–î–∏—Å–ø–µ—Ç—á–µ—Ä –ö–æ–º–∞–Ω–¥:** –ï–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω—ã–π, –∫—Ç–æ —á–∏—Ç–∞–µ—Ç –æ—á–µ—Ä–µ–¥—å –∫–æ–º–∞–Ω–¥ –∏ —Ä–∞–∑–¥–∞–µ—Ç –∏—Ö –ø–ª–∞–≥–∏–Ω–∞–º.



---

## 2. –ü–æ—Ç–æ–∫ –ö–æ–º–∞–Ω–¥ (Command Flow)

–≠—Ç–æ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è —á–∞—Å—Ç—å. –ß—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤ —á—Ç–µ–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏ (Consumer Conflict), —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ö–∞–Ω–∏–∑–º **Central Dispatch**.

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–µ–Ω—è–µ—Ç Threshold –Ω–∞ 150

1.  **Frontend:** `sendCommand('blob_detection', 'set_params', { threshold: 150 })`.
2.  **API:** –ü–æ–ª—É—á–∞–µ—Ç JSON -> –∫–ª–∞–¥–µ—Ç –≤ `EventBus Command Queue`.
3.  **CameraWorker:**
    * –í —Ü–∏–∫–ª–µ `while` –≤—ã–∑—ã–≤–∞–µ—Ç `bus.get_command()`.
    * **–®–ê–ì 1 (Dispatch):** –í—ã–∑—ã–≤–∞–µ—Ç `bus.dispatch_now(cmd)`. –≠—Ç–æ –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–µ—Ä–µ–¥–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É –≤—Å–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º (–ü–ª–∞–≥–∏–Ω–∞–º) *–±–µ–∑ –æ—á–µ—Ä–µ–¥–∏*.
    * **–®–ê–ì 2 (Hardware Check):** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç `target`. –ï—Å–ª–∏ —ç—Ç–æ `camera_0` (–∏–ª–∏ `all_cameras`), –ø—Ä–∏–º–µ–Ω—è–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–π –∫–∞–º–µ—Ä–µ (—ç–∫—Å–ø–æ–∑–∏—Ü–∏—è, –≥–µ–π–Ω). –ï—Å–ª–∏ –Ω–µ—Ç ‚Äî –∏–≥–Ω–æ—Ä–∏—Ä—É–µ—Ç.
4.  **–ü–ª–∞–≥–∏–Ω (BlobDetection):** –ü–æ–ª—É—á–∞–µ—Ç –≤—ã–∑–æ–≤ callback-—Ñ—É–Ω–∫—Ü–∏–∏, –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å–≤–æ–π `self.threshold`.
5.  **–°–ª–µ–¥—É—é—â–∏–π –∫–∞–¥—Ä:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è —É–∂–µ —Å –Ω–æ–≤—ã–º –ø–æ—Ä–æ–≥–æ–º.

---

## 3. –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ù–∞–ø–∏—Å–∞–Ω–∏–µ –ü–ª–∞–≥–∏–Ω–∞ (PipelineStage)

–ü–ª–∞–≥–∏–Ω ‚Äî —ç—Ç–æ –∫–ª–∞—Å—Å-–Ω–∞—Å–ª–µ–¥–Ω–∏–∫ `PipelineStage`. –û–Ω –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–∞–¥—Ä –∏ –º–æ–∂–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –∫–æ–º–∞–Ω–¥—ã.

### –®–∞–±–ª–æ–Ω –ü–ª–∞–≥–∏–Ω–∞

**–§–∞–π–ª:** `src/stages/my_cool_plugin.py`

```pythonfrom typing import Dictfrom loguru import loggerfrom src.core.pipeline import PipelineStage, FrameContextclass MyCoolPlugin(PipelineStage):    def __init__(self):        super().__init__("my_cool_plugin") # –£–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –ø–ª–∞–≥–∏–Ω–∞        self._subscribed = False                # –í–Ω—É—Ç—Ä–µ–Ω–Ω–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ        self.param_value = 50     def _handle_command(self, payload: Dict):        """        –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥ –æ—Ç EventBus.        –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –í–æ—Ä–∫–µ—Ä–æ–º —á–µ—Ä–µ–∑ dispatch_now (—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ).        """        args = payload.get("args", {})        if "value" in args:            self.param_value = int(args["value"])            logger.info(f"üîß MyPlugin: Value set to {self.param_value}")    def process(self, ctx: FrameContext):        # 1. –ü–û–î–ü–ò–°–ö–ê –ù–ê –ö–û–ú–ê–ù–î–´ (–û–¥–∏–Ω —Ä–∞–∑)        if ctx.bus and not self._subscribed:            # target="my_cool_plugin", cmd="set_params"            ctx.bus.subscribe("my_cool_plugin", "set_params", self._handle_command)            self._subscribed = True        # 2. –ß–¢–ï–ù–ò–ï –î–ê–ù–ù–´–•        # –ù–∞–ø—Ä–∏–º–µ—Ä, –±–µ—Ä–µ–º –∫–∞–¥—Ä –∏ –∫–æ–Ω—Ñ–∏–≥        frame = ctx.frame                # –ï—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ—Ç –¥—Ä—É–≥–∏—Ö –ø–ª–∞–≥–∏–Ω–æ–≤:        # keypoints = ctx.get_data("vision", "keypoints", [])        # 3. –õ–û–ì–ò–ö–ê        # ... —Ç—É—Ç –¥–µ–ª–∞–µ–º –º–∞–≥–∏—é —Å frame ...        result_metric = self.param_value * 2        # 4. –ó–ê–ü–ò–°–¨ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í (–î–ª—è –§—Ä–æ–Ω—Ç–µ–Ω–¥–∞)        # –≠—Ç–∏ –¥–∞–Ω–Ω—ã–µ –ø–æ–ø–∞–¥—É—Ç –≤ JSON –ø–∞–∫–µ—Ç –ø–æ–¥ –∫–ª—é—á–æ–º "results.my_cool_plugin"        output_data = {            "metric": result_metric,            "status": "ok"        }        ctx.set_data("my_cool_plugin", output_data)        # 5. UI (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è        # ctx.ui.notify("Plugin Info", f"Value is {result_metric}")

### –ü—Ä–∞–≤–∏–ª–∞ —Ä–∞–±–æ—Ç—ã —Å Context (`ctx`)

- **–ß—Ç–µ–Ω–∏–µ:**¬†`ctx.get_data("namespace", "key", default)`
  
- **–ó–∞–ø–∏—Å—å:**¬†`ctx.set_data("namespace", data_dict)`
  
- **–î–æ—Å—Ç—É–ø –∫ Bus:**¬†`ctx.bus`¬†(–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥¬†*–¥—Ä—É–≥–∏–º*).
  

---

## 4. API Reference (WebSocket Protocol)

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–ª—É—á–∞–µ—Ç –ø–æ—Ç–æ–∫ —Å–æ—Å—Ç–æ—è–Ω–∏–π. –ö–∞–∂–¥—ã–π –ø–∞–∫–µ—Ç ‚Äî –ø–æ–ª–Ω—ã–π —Å–Ω–∏–º–æ–∫ —Å–∏—Å—Ç–µ–º—ã.

**URL:**¬†`ws://localhost:8000/ws/stream`

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ü–∞–∫–µ—Ç–∞ (Server -> Client)

JSON

```
{
  "frame_id": 10500,          // uint64: ID –∫–∞–¥—Ä–∞
  "camera_id": 0,             // int: ID –∫–∞–º–µ—Ä—ã
  "fps": 60.0,                // float: FPS —Å–∏—Å—Ç–µ–º—ã

  // === –ì–õ–ê–í–ù–´–ï –î–ê–ù–ù–´–ï –û–¢ –ü–õ–ê–ì–ò–ù–û–í ===
  "results": {

    // –ü–ª–∞–≥–∏–Ω: Vision (–ù–µ–π—Ä–æ—Å–µ—Ç—å)
    "vision": {
      "keypoints": [
        { "id": "hip", "x": 100, "y": 200, "score": 0.9 }
      ]
    },

    // –ü–ª–∞–≥–∏–Ω: Marker Manager (–†—É—á–Ω—ã–µ —Ç–æ—á–∫–∏)
    "marker_manager": {
      "markers": {
        "tool_1": { "x": 50, "y": 50, "label": "My Point" }
      }
    },

    // –ü–ª–∞–≥–∏–Ω: Geometry Manager (–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã)
    "geometry": {
      "tool_angle_1": {
         "type": "angle",
         "points": ["hip", "knee", "ankle"],
         "value": 145.5,
         "valid": true,
         "color": "#fbbf24"
      }
    },

    // –ü–ª–∞–≥–∏–Ω: Camera Control (–°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–ª–∞–π–¥–µ—Ä–æ–≤)
    "camera_control": {
       "exposure": 157,
       "gain": 0,
       "auto_exposure": false,
       "threshold": 200
    }
  },

  // === –í–ò–î–ñ–ï–¢–´ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ===
  "widgets": [],       // –û–±–Ω–æ–≤–ª–µ–Ω–∏—è –≤–∏–¥–∂–µ—Ç–æ–≤ –¥–∞—à–±–æ—Ä–¥–∞
  "notifications": [], // –í—Å–ø–ª—ã–≤–∞—é—â–∏–µ —Ç–æ—Å—Ç—ã (–æ—à–∏–±–∫–∏/–∏–Ω—Ñ–æ)

  // === –°–¢–ê–¢–£–° ===
  "active_plugins": [
    { "id": "vision", "performance_ms": 3.2 }
  ],
  "errors": []
}
```

### –ö–æ–º–∞–Ω–¥—ã (Client -> Server)

–§—Ä–æ–Ω—Ç–µ–Ω–¥ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç JSON –≤ WebSocket.

**–§–æ—Ä–º–∞—Ç:**

JSON

```
{
  "target": "target_id",  // ID –ø–ª–∞–≥–∏–Ω–∞ –∏–ª–∏ 'camera_0'
  "payload": {
    "cmd": "command_name",
    "args": { ... }
  }
}
```

**–ü—Ä–∏–º–µ—Ä—ã:**

1. **–ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–µ—Ä—ã (Hardware):**
  
  - Target:¬†`camera_0`¬†(–∏–ª–∏¬†`camera_control`¬†-> –ø–µ—Ä–µ—Å—ã–ª–∫–∞)
    
  - Cmd:¬†`set_params`
    
  - Args:¬†`{"exposure": 500, "auto_exposure": false}`
    
2. **–ò–∑–º–µ–Ω–∏—Ç—å –ø–æ—Ä–æ–≥ –¥–µ—Ç–µ–∫—Ç–æ—Ä–∞ (Software):**
  
  - Target:¬†`blob_detection`
    
  - Cmd:¬†`set_params`
    
  - Args:¬†`{"threshold": 120}`
    
3. **–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç (Geometry):**
  
  - Target:¬†`geometry_manager`
    
  - Cmd:¬†`cmd_add_tool`
    
  - Args:¬†`{"id": "t1", "type": "angle", "points": ["p1", "p2", "p3"]}`
    

---

## 5. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–ª–∞–≥–∏–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º—É

1. –°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª –≤¬†`src/plugins/`¬†–∏–ª–∏¬†`src/stages/`.
  
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∞—Å—Å –∏ —Ñ—É–Ω–∫—Ü–∏—é —Ñ–∞–±—Ä–∏–∫—É:
  
  Python
  
  ```
  def create_plugin():
     return MyPlugin()
  ```
  
3. –°–∏—Å—Ç–µ–º–∞ (`loader.py`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞–π–¥–µ—Ç –µ–≥–æ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ.
  
4. –ï—Å–ª–∏ –ø–ª–∞–≥–∏–Ω—É –Ω—É–∂–Ω–æ API (REST), –¥–æ–±–∞–≤—å—Ç–µ —Ñ–∞–π–ª¬†`router.py`¬†–≤ –ø–∞–ø–∫—É –ø–ª–∞–≥–∏–Ω–∞, –∏ –æ–Ω —Ç–æ–∂–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.